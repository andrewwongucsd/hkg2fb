<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE-edge">
  <title>HKG2FB</title>
</head>
<body>
  <script>
  function autofill(){
    document.getElementById('albumid').value = '161087720974265';
    document.getElementById('pageid').value = '113793925703645';
  }
  function publishPhotoToPageAlbum(){
    console.log("publishPhotoToPageAlbum Function");
    var pageInfo = {};
    var payload = {};
    var albumid = document.getElementById('albumid').value.trim();
    var pageid = document.getElementById('pageid').value.trim();
    var accessToken = document.getElementById('tokenid').value.trim();
    if(pageid.length == 0 || accessToken.length == 0){
      alert("Page Id and Access Token Missing.");
    }
    var url = '';
    var root = 'https://graph.facebook.com';
    payload.url = 'https://i1.i-mg.co/ilGJ3.png';
    payload.message = '有時會見到佢地,得閒可捉番隻番屋企';
    payload.no_story = true;

    FB.login(function(response){
      console.log(response);
      if(response.authResponse){
        if(albumid == ''){
          url = '/'+pageid+'/albums?access_token='+accessToken;
          FB.api(
            url,
            'POST',
            {
              message: '',
              name: 'To Be Named.'
            },
            function(response){
              if(response && !response.error){
                albumid = response.id;
                console.log(response);
              }else{
                console.log('failed to create photo album');
              }
            }
          )
        }
        url = '/'+albumid+'/photos?access_token='+accessToken;
        // url = '/'+albumid+'/photos';
        setTimeout(FB.api(
          url,
          'POST',
          payload,
          function(response){
            console.log(response);
            console.log(root+url);
            console.log(payload)
            if(response && !response.error){
              document.getElementById('status').innerHTML = 'successful '+payload.url;
            }else{
              document.getElementById('status').innerHTML = 'fail '+payload.url;
            }
          }
        ), 1000);
      }else{
        console.log('User cancelled Login or did not fully authorize.');
      }
    },{
      scope: 'email, manage_pages, publish_pages, publish_actions, public_profile',
      return_scopes: true
    });

    // deleteAllCookies();
  }
  window.fbAsyncInit = function(){
    FB.init({
      appId: '1827005040861675',cookie: true, xfbml: true,version: 'v2.7'
    });
    // autofill();
    // FB.getLoginStatus(function(response){
    //   statusChangeCallback(response, publishPhotoToPageAlbum);
    // })
  };

  (function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/en_US/sdk.js";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));

  function publish(){
    FB.getLoginStatus(function(response){
      statusChangeCallback(response, publishPhotoToPageAlbum);
    })
  }
  function statusChangeCallback(response, loggedInToActFunction){
    // get Page Access Token to publish photos to photo album
    console.log(response);
    if(response.status === 'connected'){
      // do things here!
      loggedInToActFunction();
    }else if(response.status === 'not_authorized'){
      document.getElementById('status').innerHTML = 'Please log in to the App.';
    }else{
      document.getElementById('status').innerHTML = 'Please log in to Facebook';
    }
  };

  function getPageAccessToken(){
    console.log("getPageAccessToken Function");
    var pageid = document.getElementById('pageid').value;
    if(pageid.trim() == ''){
      alert("Page id cannot be emptied");
      return;
    }
    var accessToken = '';

    FB.login(function(response){
      if(response.authResponse){
        FB.api('/me/accounts',function(response){
          for(var i = 0; i < response.data.length; i++){
            if(response.data[i].id === pageid){
              accessToken = response.data[i].access_token;
              document.getElementById('tokenid').value = accessToken;
              break;
            }else{
            }
          }
        })
      }else{
        console.log('User cancelled Login or did not fully authorize.');
      }
    },{
      scope: 'email, manage_pages, publish_pages, publish_actions, public_profile',
      return_scopes: true
    })
  }
  function tokenRetriever(){
    FB.getLoginStatus(function(response){
      statusChangeCallback(response, getPageAccessToken);
    })
  }
  function preprocess(){
    var input = document.getElementById('hkgcode').value.trim();
    var data = [];
    var state = 0;
    var letters = /^[A-Za-z]+$/;

    for(var i = 0; i < input.length; i++){
      console.log(i+" - "+input[i]+" - "+typeof(input[i]));
      if(i == 0 || state == 0){
        // [ or text expecting,
        // otherwise state remain 0;
        if(input[i] == ['[']){
          state = 1; // [] content read.
        }else{
          album_description += input[i];
          state = 2; // concat album_description
        }
      }else if(state == 1){ // [] content read.
        if(input[i].match(letters)){
          var code = '';
          while(i < input.length){
            console.log(i+" - "+input[i]+" - "+typeof(input[i]));
            if(input[i] == ']'){
              if(code == 'img'){
                state = 3; // img_url read.
                break;
              }else if(code == 'sosad'){
                state = 5; // exception handling.
                data[data.length - 1].img_text += '[sosad]';
                break;
              }else{
                state = 1;
                break;
              }
            }else if(input[i].match(letters)){
              code += input[i];
            }else{
              alert("Exception Error in state 1A. "+i+" - "+input[i]+" - typeof "+typeof(input[i]));
              return;
            }
            i++;
          }
        }else if(input[i] == '[' || input[i] == ' '){

        }else if(input[i] == '/'){
          while(i < input.length){
            console.log("inside / "+input[i]+" - "+i);
            if(input[i++] == ']'){
              break;
            }
          }
        }else{
          alert("Exception occurs in state 1B."+i+" - "+input[i]+" - typeof "+typeof(input[i]));
          return;
        }
      }else if(state == 2){ // album description
        var album_description = '';
        while(i < input.length){
          console.log(i+" - "+input[i]+" - "+typeof(input[i]));

          if(input[i] == '['){
            data.push({
              message: album_description,
              name: 'To be Named.'
            });
            state = 1;
            break;
          }else{
            album_description += input[i];
          }
          i++;
        }
      }else if(state == 3){ // img_url read.
        var img_url = ''
        while(i < input.length){
          console.log(i+" - "+input[i]+" - "+typeof(input[i]));

          if(input[i] == '['){
            data.push({
              img_url: img_url
            });
            while(i < input.length && input[i] != ']'){
              console.log(i+" - "+input[i]+" - "+typeof(input[i]));
              i++;
            }
            state = 4;
            break;
          }else{
            img_url += input[i];
          }
          i++;
        }
      }else if(state == 4){ //img_text read.
        var img_text = '';
        while(i < input.length){
          console.log(i+" - "+input[i]+" - "+typeof(input[i]));

          if(input[i] == '[' || i == input.length - 1){
            if(img_text.length == 0){
              // doing nothing.
            }else{
              data[data.length - 1].img_text = img_text;
            }
            state = 1;
            break;
          }else{
            img_text += input[i];
          }
          i++;
        }
      }else if(state == 5){
          while(i < input.length){
            console.log(i+" - "+input[i]+" - "+typeof(input[i]));
            if(input[i] == '['){
              state = 1;
              break;
            }
            data[data.length - 1].img_text += input[i];
            i++;
          }
      }else{
          alert("exception.");
      }
    }
    console.log(data);
  }
  function getAlbumAndPageId(){
    //https://www.facebook.com/%E7%AA%AE%E9%81%8A%E9%81%8A%E8%A8%98-113793925703645/photos/?tab=album&album_id=161087720974265
    var url = document.getElementById('url').value;
    for(var i = 0; i < url.length; i++){
      if(url[i] == 'p'){
        var pos = i;
        if(url.slice(i,'photos'.length) == 'photos'){
          i--;
          var pageid = '';
          while(i > 0 && url[i] != '-'){
            pageid = url[i] + pageid;
            i--;
          }
          document.getElementById('pageid').value = pageid;
          i = pos;
        }
      }else if(url[i] == 'a'){
        var pos = i;
        var albumid = '';
        if(url.slice(i,'album_id='.length) == 'album_id='){
          while(i < url.length){
            if(url[i]>= '0' && url[i]<= '9'){
              albumid += url[i];
            }else{
              break;
            }
            i++;
          }
          document.getElementById('albumid').value = albumid;
          i == url.length;
        }
      }
    }
  }

  </script>
    URL: <input id="url" type="text" name="url">
    <button onclick="getAlbumAndPageId()">Get Album ID and Page Id</button><br>
    album id: <input id="albumid" type="text" name="albumid"><br>
    page id: <input id="pageid" type="text" name="pageid"><br>
    access token: <input id="tokenid" type="text" name="tokenid">
    <button onclick="tokenRetriever()"> Get Page Token to publish </button>
    <br>
  <textarea id="hkgcode" rows="4" cols="50" name="comment"></textarea>
  <button onclick="preprocess()"> Preprocess Code </button>
  <br>
  <button onclick="publish()"> Parse and Publish! </button>
  <div id="status"></div>
  <fb:login-button scope="public_profile,email" onlogin="checkLoginState();"></fb:login-button>
  <!-- <button onclick="login()">Login</button> -->
  <div
    class="fb-like"
    data-share="true"
    data-width="450"
    data-show-faces="true">
  </div>
</body>
</html>
