<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE-edge">
  <title>HKG2FB</title>
</head>
<body>
  <script>
  var compiled = [];
  function autofill(){
    document.getElementById('url').value = "    //https://www.facebook.com/%E7%AA%AE%E9%81%8A%E9%81%8A%E8%A8%98-113793925703645/photos/?tab=album&album_id=161087720974265";
  }
  function publishPhotoToPageAlbum(){
    console.log("publishPhotoToPageAlbum Function");
    var pageInfo = {};
    var payload = {};
    var albumid = document.getElementById('albumid').value.trim();
    var pageid = document.getElementById('pageid').value.trim();
    var accessToken = document.getElementById('tokenid').value.trim();
    if(pageid.length == 0 || accessToken.length == 0){
      alert("Page Id and Access Token Missing.");
      return;
    }
    var url = '';
    var root = 'https://graph.facebook.com';


    FB.login(function(response){
      console.log(response);
      if(response.authResponse){
        var yes_album_id = true;
        if(albumid == ''){
          yes_album_id = false;
          url = '/'+pageid+'/albums?access_token='+accessToken;
          FB.api(
            url,
            'POST',
            compiled[0],
            function(response){
              if(response && !response.error){
                albumid = response.id;
                document.getElementById('albumid').value = albumid;
                console.log(response);
              }else{
                console.log('failed to create photo album');
              }
            }
          )
        }
        if(yes_album_id){
          compiled[1].message = compiled[0].message + '\n'+compiled[1].message;
        }
        setTimeout(function(){
          for(var index = 1; index < compiled.length; index++){
              albumid = document.getElementById('albumid').value;
              url = '/'+albumid+'/photos?access_token='+accessToken;
              console.log(url);
              console.log(compiled[index]);
              FB.api(url,'POST',compiled[index],
              function(response){
                console.log(response);
                if(response && !response.error){
                  document.getElementById('status').innerHTML = 'successful ';
                }else{
                  document.getElementById('status').innerHTML = 'failed';
                }
              }
            );
          }
        },10000);
      }else{
        console.log('User cancelled Login or did not fully authorize.');
      }
    },{
      scope: 'email, manage_pages, publish_pages, publish_actions, public_profile',
      return_scopes: true
    });

    // deleteAllCookies();
  }
  window.fbAsyncInit = function(){
    FB.init({
      appId: '1827005040861675',cookie: true, xfbml: true,version: 'v2.7'
    });
    // autofill();
    // FB.getLoginStatus(function(response){
    //   statusChangeCallback(response, publishPhotoToPageAlbum);
    // })
  };

  (function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/en_US/sdk.js";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));

  function publish(){
    if(compiled.length == 0){
      alert("Data are not ready.");
      return;
    }
    FB.getLoginStatus(function(response){
      statusChangeCallback(response, publishPhotoToPageAlbum);
    })
  }
  function statusChangeCallback(response, loggedInToActFunction){
    // get Page Access Token to publish photos to photo album
    console.log(response);
    if(response.status === 'connected'){
      // do things here!
      loggedInToActFunction();
    }else if(response.status === 'not_authorized'){
      document.getElementById('status').innerHTML = 'Please log in to the App.';
    }else{
      document.getElementById('status').innerHTML = 'Please log in to Facebook';
    }
  };

  function getPageAccessToken(){
    console.log("getPageAccessToken Function");
    var pageid = document.getElementById('pageid').value;
    if(pageid.trim() == ''){
      alert("Page id cannot be emptied");
      return;
    }
    var accessToken = '';

    FB.login(function(response){
      if(response.authResponse){
        FB.api('/me/accounts',function(response){
          for(var i = 0; i < response.data.length; i++){
            if(response.data[i].id === pageid){
              accessToken = response.data[i].access_token;
              document.getElementById('tokenid').value = accessToken;
              break;
            }else{
            }
          }
        })
      }else{
        console.log('User cancelled Login or did not fully authorize.');
      }
    },{
      scope: 'email, manage_pages, publish_pages, publish_actions, public_profile',
      return_scopes: true
    });
  }
  function tokenRetriever(){
    FB.getLoginStatus(function(response){
      statusChangeCallback(response, getPageAccessToken);
    })
  }
  function preprocess(){
    var input = document.getElementById('hkgcode').value.trim();
    var data = [];
    var state = 0;
    var letters = /^[A-Za-z]+$/;

    for(var i = 0; i < input.length; i++){
      console.log(i+" - "+input[i]+" - "+typeof(input[i]));
      if(i == 0 || state == 0){
        // [ or text expecting,
        // otherwise state remain 0;
        if(input[i] == ['[']){
          state = 1; // [] content read.
        }else{
          album_description += input[i];
          state = 2; // concat album_description
        }
      }else if(state == 1){ // [] content read.
        console.log("State 1: [] content read.");
        if(input[i].match(letters) || parseInt(input[i], 10) >= 0){
          var code = '';
          while(i < input.length){
            console.log(i+" - "+input[i]+" - "+typeof(input[i]));
            console.log(code);
            var filter = {};
            filter.img = {next_state: 3, append: false};
            filter.sosad = {next_state: 5, append: true};
            filter.photo = {next_state: 5, append: true};
            filter.url = {next_state: 5, append: false};
            filter["369"] = {next_state: 5, append: true};
            filter.banghead = {next_state: 5, append: true};
            filter.bouncer = {next_state: 5, append: true};
            filter.shocking = {next_state: 5, append: true};
            filter.red = {next_state: 5, append: false};
            filter.green = {next_state: 5, append: false};
            filter.b = {next_state: 5, append: false};
            filter.blue = {next_state: 5, append: false};
            filter.size = {next_state: 5, append: false};
            filter.flowerface = {next_state: 5, append: true};
            filter.bomb = {next_state: 5, append:true};
            filter.photo = {next_state: 5, append: true};

            if(input[i] == ']'){
              if(parseInt(code.slice(-1), 10) >= 0){
                code = code.substring(0, code.length - 2);
              }
              if(code in filter){
                console.log(filter[code]);
                state = filter[code].next_state;
                if(filter[code].append){
                  data[data.length - 1].message += "["+code+"]";
                }
                break;
              }else if(data.length == 0){
                state = 0;
                break;
              }else{
                state = 1;
                break;
              }
            }else if(input[i].match(letters) || parseInt(input[i], 10) >=0 ){
              code += input[i];
            }else{
              alert("Exception Error in state 1A. "+i+" - "+input[i]+" - typeof "+typeof(input[i]));
            }
            i++;
          }
        }else if(input[i] == '[' || input[i] == ' ' || input[i] == '\n'){

        }else if(input[i] == '/'){
          while(i < input.length){
            console.log("inside / "+input[i]+" - "+i);
            var code = '';
            i++;
            while(input[i] != ']'){
              code += input[i];
              i++;
            }
            if(input[i] == ']'){
              console.log(code);
              if(parseInt(code.slice(-1), 10) >= 0){
                code = code.substring(0, code.length - 2);
              }
              console.log(code);
              filter.url = {next_state: 5};
              filter.img = {next_state: 3};
              filter.size = {next_state: 5};
              filter.blue = {next_state: 5};
              filter.b = {next_state: 5};
              filter.red = {next_state: 5};
              filter.green = {next_state: 5};
              if(code in filter){
                state = filter[code].next_state;
              }
              break;
            }
            i++;
          }
        }else{
          alert("Exception occurs in state 1B."+i+" - "+input[i]+" - typeof "+typeof(input[i]));
        }
      }else if(state == 2){ // album description
        console.log("State 2: Album Description.");
        var album_description = '';
        while(i < input.length){
          console.log(i+" - "+input[i]+" - "+typeof(input[i]));

          if(input[i] == '['){
            data.push({
              message: album_description,
              name: 'To be Named.'
            });
            state = 1;
            break;
          }else{
            album_description += input[i];
          }
          i++;
        }
      }else if(state == 3){ // img_url read.
        console.log("State 3: img_url read.");
        var img_url = ''
        while(i < input.length){
          console.log(i+" - "+input[i]+" - "+typeof(input[i]));

          if(input[i] == '['){
            if(data.length == 0){
              data.push({message:'', name:''});
            }
            data.push({
              url: img_url,
              no_story: false
            });
            while(i < input.length && input[i] != ']'){
              console.log(i+" - "+input[i]+" - "+typeof(input[i]));
              i++;
            }
            state = 4;
            break;
          }else{
            img_url += input[i];
          }
          i++;
        }
      }else if(state == 4){ //message read.
        console.log("State 4: message read.");
        var img_text = '';
        while(i < input.length){
          console.log(i+" - "+input[i]+" - "+typeof(input[i]));

          if(input[i] == '[' || i == input.length - 1){
            console.log(img_text.slice(img_text.length-2, img_text.length));
            if(img_text.slice(img_text.length-2, img_text.length) == ':-'){
              img_text += input[i];
            }else if(img_text.length == 0){
              // doing nothing.
              state = 1;
              break;
            }else{
              data[data.length - 1].message = img_text;
              state = 1;
              break;
            }
          }else{
            img_text += input[i];
          }
          i++;
        }
      }else if(state == 5){
        console.log("State 5: Exception Handling.");
          while(i < input.length){
            console.log(i+" - "+input[i]+" - "+typeof(input[i]));
            if(input[i] == '['){
              var message = data[data.length - 1].message;
              console.log(message.slice(message.length-2, message.length));
              if(message.slice(message.length-2, message.length) == ':-'){

              }else{
                state = 1;
                break;
              }
            }
            //myObj.hasOwnProperty('myKey') - boolean
            if(data.length == 0){
              data.push({message: '', no_story: false});
            }
            data[data.length - 1].message += input[i];
            i++;
          }
      }else{
          alert("exception.");
      }
    }
    console.log(data);
    compiled = data;
  }
  function getAlbumAndPageId(){
    var url = document.getElementById('url').value;
    array = url.split("/");
    pageid = array[3].split("-")[1];
    document.getElementById('pageid').value = pageid;

    for(var i = 0; i < array[5].length; i++){
      if(array[5][i] == 'a'){
        var pos = i;
        var albumid = '';
        console.log(array[5].slice(i, i+'album_id='.length));
        if(array[5].slice(i,i+'album_id='.length) == 'album_id='){
          i = i+('album_id='.length);
          while(i < array[5].length){
            console.log(i+" - "+array[5][i]);
            if(parseInt(array[5][i],10)>=0){
              albumid += array[5][i];
            }else{
              break;
            }
            i++;
          }
          console.log('album id: '+albumid);
          document.getElementById('albumid').value = albumid;
          i = array[5].length;
        }
      }
    }
  }

  </script>
    URL: <input id="url" type="text" name="url">
    <button onclick="getAlbumAndPageId()">Get Album ID and Page Id</button><br>
    album id: <input id="albumid" type="text" name="albumid"><br>
    page id: <input id="pageid" type="text" name="pageid"><br>
    access token: <input id="tokenid" type="text" name="tokenid">
    <button onclick="tokenRetriever()"> Get Page Token to publish </button>
    <br>
  <textarea id="hkgcode" rows="35" cols="101" name="comment"></textarea>
  <button onclick="preprocess()"> Preprocess Code </button>
  <br>
  <button onclick="publish()"> Parse and Publish! </button>
  <div id="status"></div>
  <fb:login-button scope="public_profile,email" onlogin="checkLoginState();"></fb:login-button>
  <!-- <button onclick="login()">Login</button> -->
  <div
    class="fb-like"
    data-share="true"
    data-width="450"
    data-show-faces="true">
  </div>
</body>
</html>
