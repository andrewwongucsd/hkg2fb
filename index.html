<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE-edge">
  <title>HKG2FB</title>
</head>
<body>
  <script>
  function deleteAllCookies() {
    var cookies = document.cookie.split(";");

    for (var i = 0; i < cookies.length; i++) {
    	var cookie = cookies[i];
    	var eqPos = cookie.indexOf("=");
    	var name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
    	document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT";
    }
}


  function publishPhotoToPageAlbum(){
    console.log("publishPhotoToPageAlbum Function");
    var pageInfo = {};
    var payload = {};
    var albumid = '161087720974265';
    var pageid = '113793925703645';
    var accessToken = '';
    var url = '';
    var root = 'https://graph.facebook.com';
    payload.url = 'https://i1.i-mg.co/ilGJ3.png';
    payload.message = '有時會見到佢地,得閒可捉番隻番屋企';
    payload.no_story = true;
    // payload.status = 'success';


    FB.login(function(response){
      console.log(response);
      if(response.authResponse){
        // First to get
        // accessToken = response.authResponse.accessToken;
        // payload.access_token = response.authResponse.accessToken;
        FB.api('/me/accounts',function(response){
          console.log('/me/accounts');
          for(var i = 0; i < response.data.length; i++){
            if(response.data[i].id === pageid){
              pageInfo = response.data[i];
              console.log(pageInfo.access_token);
              break;
            }
          }
        });
        accessToken = 'EAAZA9psJ2oesBALhZB5twLnCmGKF3F8bhEtNTcxN1SIJKpSKvholPnBIAmZBhsVwROD6KKdJf32Pb2UojZCLbexZCMdiLBCjqEdaXKgD0qq9m7H4Y9ZCZA73AcvKMzoyimLVrqjp9LtZCLGzOZCUDflamWwfSbUiUYwsUuEzjvZBZC7qVmDguTZAkhow';
        url = '/'+albumid+'/photos?access_token='+accessToken;
        // url = '/'+albumid+'/photos';
        setTimeout(FB.api(
          root+url,
          'POST',
          payload,
          function(response){
            console.log(response);
            console.log(root+url);
            console.log(payload)
            if(response && !response.error){
              document.getElementById('status').innerHTML = 'successful '+payload.url;
            }else{
              document.getElementById('status').innerHTML = 'fail '+payload.url;
            }
          }
        ), 1000);
      }else{
        console.log('User cancelled Login or did not fully authorize.');
      }
    },{
      scope: 'email, manage_pages, publish_pages, publish_actions, public_profile',
      return_scopes: true
    });

    // deleteAllCookies();
  }
  window.fbAsyncInit = function(){
    FB.init({
      appId: '1827005040861675',cookie: true, xfbml: true,version: 'v2.7'
    });

    FB.getLoginStatus(function(response){
      statusChangeCallback(response, publishPhotoToPageAlbum);
    })
  };

  (function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/en_US/sdk.js";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));

  function click(){
    FB.getLoginStatus(function(response){
      statusChangeCallback(response, publishPhotoToPageAlbum);
    })
  }
  function statusChangeCallback(response, loggedInToActFunction){
    // get Page Access Token to publish photos to photo album
    console.log(response);
    if(response.status === 'connected'){
      // do things here!
      loggedInToActFunction();
    }else if(response.status === 'not_authorized'){
      document.getElementById('status').innerHTML = 'Please log in to the App.';
    }else{
      document.getElementById('status').innerHTML = 'Please log in to Facebook';
    }
  };

  function getPageAccessToken(){
    console.log("getPageAccessToken Function");
    var pageid = document.getElementById('pageid');
    if(pageid === ''){
      alert("Page id cannot be emptied");
    }
    var accessToken = '';

    FB.login(function(response){
      if(response.authResponse){
        FB.api('/me/accounts',function(response){
          console.log(response);
          for(var i = 0; i < response.data.length; i++){
            if(response.data[i].id === pageid){
              accessToken = response.data[i];
              alert(accessToken);
              document.getElementById('tokenid').value = accessToken;
              break;
            }else{
              console.log(pageid+" vs "+response.data[i].id);
            }
          }
        })
      }else{
        console.log('User cancelled Login or did not fully authorize.');
      }
    },{
      scope: 'email, manage_pages, publish_pages, publish_actions, public_profile',
      return_scopes: true
    })
  }
  function tokenRetriever(){
    FB.getLoginStatus(function(response){
      statusChangeCallback(response, getPageAccessToken);
    })
  }

  </script>
    album id: <input id="albumid" type="text" name="albumid"><br>
    page id: <input id="pageid" type="text" name="pageid"><br>
    access token: <input id="tokenid" type="text" name="tokenid">
    <button onclick="tokenRetriever()"> Get Page Token to publish </button>
    <br>
  <textarea id="hkgcode" rows="4" cols="50" name="comment"></textarea>
  <button onclick="parsenpost()"> Parse and Post! </button>
  <div id="status"></div>
  <fb:login-button scope="public_profile,email" onlogin="checkLoginState();"></fb:login-button>
  <!-- <button onclick="login()">Login</button> -->
  <div
    class="fb-like"
    data-share="true"
    data-width="450"
    data-show-faces="true">
  </div>
</body>
</html>
